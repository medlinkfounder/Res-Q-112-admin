<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ResQ 112 - View Incidents</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700;900&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet"/>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <style>
        :root {
            --bg-color: #000000;
            --text-color: #e0e0e0;
            --text-color-light: #fff;
            --text-highlight-glow: #00ffff;
            --glass-card-bg: rgba(255,255,255,0.05);
            --glass-card-border: rgba(255,255,255,0.1);
            --header-bg: rgba(0,0,0,0.3);
            --primary-font: 'Exo 2', sans-serif;
            --secondary-font: 'Space Grotesk', sans-serif;
        }
        body.light-theme {
            --bg-color: #eaf2f8;
            --text-color: #34495e;
            --text-color-light: #1c2833;
            --text-highlight-glow: #0056b3;
            --glass-card-bg: rgba(255,255,255,0.6);
            --glass-card-border: rgba(220,220,220,0.8);
            --header-bg: rgba(255,255,255,0.2);
        }
        body{
            font-family: var(--secondary-font);
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        #ripple-canvas{position:fixed;top:0;left:0;width:100%;height:100%;z-index:0}
        .content-overlay{position:relative;z-index:2;min-height:100vh;}
        header { background-color: var(--header-bg); }
        .logo-container span { font-family: var(--secondary-font); color: var(--text-color-light); }
        h2, h3 { color: var(--text-highlight-glow); }
        .glass-card{
            background:var(--glass-card-bg); backdrop-filter:blur(10px); border:1px solid var(--glass-card-border);
            padding:24px; border-radius:16px; transition:all .3s ease; color: var(--text-color);
        }
        #theme-switcher {
            background: none; border: 1px solid var(--glass-card-border); border-radius: 50%; width: 40px; height: 40px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 8px; color: var(--text-color-light);
        }
        .sun-icon { display: none; }
        body.light-theme .moon-icon { display: none; }
        body.light-theme .sun-icon { display: block; }
    </style>
    <script>
      (function() {
          const currentTheme = localStorage.getItem('theme');
          if (currentTheme === 'light') { document.body.classList.add('light-theme'); }
      })();
    </script>
</head>
<body>
<canvas id="ripple-canvas"></canvas>

<div class="content-overlay flex flex-col min-h-screen">
    <header class="p-4 flex justify-between items-center">
        <div class="flex items-center space-x-4 logo-container">
            <img src="logo.png.png" alt="logo" class="h-12 w-12"/>
            <span class="text-2xl font-bold">ResQ 112</span>
        </div>
        <div class="flex items-center gap-4">
            <a href="dashboard.html" class="text-white hover:text-cyan-300">Dashboard</a>
            <select id="languageSwitcher" class="bg-black/50 text-white p-2 rounded border border-gray-700">
                <option value="en">English</option>
                <option value="hi">हिन्दी</option>
                <option value="as">অসমীয়া</option>
            </select>
            <button id="theme-switcher" title="Toggle theme">
                <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.106a.75.75 0 010 1.06l-1.591 1.59a.75.75 0 11-1.06-1.06l1.59-1.591a.75.75 0 011.06 0zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.894 17.894a.75.75 0 011.06 0l1.59 1.591a.75.75 0 11-1.06 1.06l-1.591-1.59a.75.75 0 010-1.06zM12 21a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 21zM5.106 17.894a.75.75 0 010-1.06l1.591-1.59a.75.75 0 111.06 1.06l-1.59 1.591a.75.75 0 01-1.06 0zM3 12a.75.75 0 01.75-.75h2.25a.75.75 0 010 1.5H3.75A.75.75 0 013 12zM6.106 5.106a.75.75 0 011.06 0l1.59 1.591a.75.75 0 11-1.06 1.06l-1.591-1.59a.75.75 0 010-1.06z"></path></svg>
                <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-3.51 1.713-6.625 4.43-8.56a.75.75 0 01.818.162z" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </header>

    <main class="container mx-auto px-4 my-8 flex-grow">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold" data-i18n="title">All Reported Incidents</h2>
        </div>
        
        <div id="loading" class="text-center py-10">
            <p data-i18n="loading_text">Loading Incident Reports...</p>
        </div>
        
        <div id="incidents-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            </div>
    </main>
</div>
<script>
// --- THEME SWITCHER LOGIC ---
const themeSwitcher = document.getElementById('theme-switcher');
themeSwitcher.addEventListener('click', () => {
    document.body.classList.toggle('light-theme');
    const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
    localStorage.setItem('theme', currentTheme);
});
// Firebase Config
const firebaseConfig = {
    apiKey: "AIzaSyBcLtaRPt6hTo4aEFRvcBwNq5-00soEjB4", authDomain: "sos-c1499.firebaseapp.com",
    databaseURL: "https://sos-c1499-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "sos-c1499",
    storageBucket: "sos-c1499.firebasestorage.app", messagingSenderId: "1008729495848",
    appId: "1:1008729495848:web:7d6c7d3a6047e2736e981d", measurementId: "G-JGBY3ZZPGC"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
// Translations
const translations = {
    en: { title: "All Reported Incidents", back_button: "Back to Dashboard", loading_text: "Loading Incident Reports...", reported_by: "Reported by", at: "at", status: "Status", view_location: "View Location" },
    hi: { title: "सभी रिपोर्ट की गई घटनाएं", back_button: "डैशबोर्ड पर वापस जाएं", loading_text: "घटना रिपोर्ट लोड हो रही हैं...", reported_by: "द्वारा रिपोर्ट किया गया", at: "पर", status: "स्थिति", view_location: "स्थान देखें" },
    as: { title: "সকলো দাখিল কৰা ঘটনা", back_button: "ডেশ্বব’ৰ্ডলৈ ঘূৰি যাওক", loading_text: "ঘটনাৰ প্ৰতিবেদন লোড হৈ আছে...", reported_by: "ৰিপোৰ্ট কৰিছে", at: "ত", status: "স্থিতি", view_location: "অৱস্থান চাওক" }
};

const container = document.getElementById("incidents-container"), loadingIndicator = document.getElementById("loading");
const incidentsRef = db.ref('incidents');
incidentsRef.on('value', (snapshot) => {
    container.innerHTML = '';
    loadingIndicator.style.display = 'none';
    const incidents = [];
    snapshot.forEach((childSnapshot) => { incidents.push(childSnapshot.val()); });
    if (incidents.length === 0) {
        container.innerHTML = `<p class="col-span-full text-center text-gray-400">No incidents have been reported yet.</p>`;
    }
    incidents.reverse().forEach((data) => {
        const date = new Date(data.timestamp);
        const lang = localStorage.getItem('lang') || 'en';
        let statusColor = 'text-yellow-400';
        if (data.status === 'Resolved') statusColor = 'text-green-400';
        if (data.status === 'In Progress') statusColor = 'text-blue-400';
        
        // **FIX:** Use data.user.name, which is always present in the incident record
        const userName = data.user ? data.user.name : "Unknown";

        const cardHTML = `
            <div class="glass-card flex flex-col justify-between">
                <div>
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-bold">${data.incidentType}</h3>
                        <span class="font-bold ${statusColor}">${data.status}</span>
                    </div>
                    <p class="text-sm text-gray-400 mb-2">
                        ${translations[lang].reported_by} <b style="color: var(--text-color-light)">${userName}</b>
                    </p>
                    <p class="mb-4 h-20 overflow-y-auto">${data.description}</p>
                    <p class="text-xs text-gray-500 font-mono">${data.ticketId}</p>
                </div>
                <div class="mt-4 pt-4 border-t flex justify-between items-center" style="border-color: var(--glass-card-border);">
                    <span class="text-xs text-gray-400">${date.toLocaleString()}</span>
                    <a href="https://maps.google.com/?q=${data.location.lat},${data.location.lng}" target="_blank" class="text-sm font-semibold" style="color: var(--text-highlight-glow);">
                        ${translations[lang].view_location}
                    </a>
                </div>
            </div>
        `;
        container.innerHTML += cardHTML;
    });
}, (error) => {
    console.error(error);
    loadingIndicator.textContent = 'Failed to load data.';
});

const switcher = document.getElementById("languageSwitcher");
function updateLanguage(lang) {
    localStorage.setItem("lang", lang);
    document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (translations[lang]?.[key]) { el.innerText = translations[lang][key]; }
    });
    incidentsRef.trigger('value'); // Refresh list to update "Reported by" text
}
switcher.addEventListener("change", e => updateLanguage(e.target.value));
window.addEventListener("load", () => {
    const savedLang = localStorage.getItem("lang") || "en";
    switcher.value = savedLang;
    updateLanguage(savedLang);
});
const canvas=document.getElementById("ripple-canvas"),ctx=canvas.getContext("2d");
canvas.width=innerWidth;canvas.height=innerHeight; let ripples=[];
class Ripple{constructor(x,y){this.x=x;this.y=y;this.radius=0;this.alpha=1;}
update(){this.radius+=1.5;this.alpha-=0.01;}
draw(){ctx.beginPath();ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);ctx.strokeStyle=`rgba(0,255,255,${this.alpha})`;ctx.stroke();}}
function animate(){ctx.clearRect(0,0,canvas.width,canvas.height);
ripples.forEach((r,i)=>{r.update();r.draw();if(r.alpha<=0)ripples.splice(i,1);});
requestAnimationFrame(animate);}
animate();
addEventListener("mousemove",e=>ripples.push(new Ripple(e.clientX,e.clientY)));
addEventListener("resize",()=>{canvas.width=innerWidth;canvas.height=innerHeight});
</script>
</body>
</html>
